name: Deploy to Staging and Production

on:
  workflow_run:
    workflows: ["Test Suite"]
    types:
      - completed
    branches: [develop, main]

env:
  REGISTRY_URL: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'develop'
    environment: staging
    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY_URL }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push images
      run: |
        docker build -t ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}/backend:staging ./apps/backend
        docker build -t ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}/frontend:staging ./apps/frontend
        docker push ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}/backend:staging
        docker push ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}/frontend:staging

    - name: Deploy to staging
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        script: |
          cd /opt/aio-creative-hub
          git pull origin develop
          cp .env.staging .env
          docker-compose pull
          docker-compose up -d --remove-orphans
          docker system prune -f

    - name: Wait for services
      run: sleep 45

    - name: Health check
      run: |
        for i in {1..30}; do
          if curl -f ${{ secrets.STAGING_URL }}/health; then
            echo "‚úÖ Staging deployment successful!"
            exit 0
          fi
          echo "Waiting for service... ($i/30)"
          sleep 10
        done
        echo "‚ùå Health check failed"
        exit 1

    - name: Run integration tests
      run: |
        npm run test:backend -- --testPathPattern=integration
      env:
        BASE_URL: ${{ secrets.STAGING_URL }}
        NODE_ENV: test

    - name: Notify staging deployment
      if: success()
      run: |
        echo "üöÄ Staging deployment completed successfully!"

  deploy-production:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'
    environment: production
    needs: [deploy-staging]
    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY_URL }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push production images
      run: |
        docker build -t ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}/backend:latest ./apps/backend
        docker build -t ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}/frontend:latest ./apps/frontend
        docker push ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}/backend:latest
        docker push ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}/frontend:latest

    - name: Create backup before deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          ./scripts/backup-db.sh

    - name: Deploy to production
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          cd /opt/aio-creative-hub
          git pull origin main
          cp .env.production .env
          docker-compose pull
          docker-compose up -d --remove-orphans
          docker system prune -f

    - name: Wait for services
      run: sleep 60

    - name: Health check
      run: |
        for i in {1..60}; do
          if curl -f ${{ secrets.PRODUCTION_URL }}/health; then
            echo "‚úÖ Production deployment successful!"
            exit 0
          fi
          echo "Waiting for service... ($i/60)"
          sleep 10
        done
        echo "‚ùå Health check failed"
        exit 1

    - name: Run smoke tests
      run: |
        npm run test:e2e -- --baseUrl=${{ secrets.PRODUCTION_URL }}
      env:
        CI: true

    - name: Create GitHub release
      if: success()
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        draft: false
        prerelease: false

    - name: Notify production deployment
      if: success()
      run: |
        echo "üéâ Production deployment completed successfully!"

    - name: Notify deployment failure
      if: failure()
      run: |
        echo "‚ùå Production deployment failed!"
        echo "Rolling back to previous version..."
      # Rollback commands would go here

  rollback:
    runs-on: ubuntu-latest
    if: failure() && github.ref == 'refs/heads/main'
    needs: [deploy-production]
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Rollback production
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          cd /opt/aio-creative-hub
          docker-compose pull
          docker-compose up -d --remove-orphans
          echo "Rolled back to previous version"
