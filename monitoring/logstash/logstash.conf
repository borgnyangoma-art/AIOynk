input {
  # Log files from services
  file {
    path => "/logs/*.log"
    type => "service_logs"
    start_position => "beginning"
  }

  # Beats input for Metricbeat
  beats {
    port => 5044
  }

  # HTTP input for custom logs
  http {
    port => 8080
    type => "http_logs"
  }
}

filter {
  # Parse service logs
  if [type] == "service_logs" {
    # Parse JSON logs
    if [message] =~ /^[{[]/ {
      json {
        source => "message"
      }
    }

    # Add timestamp
    date {
      match => [ "timestamp", "ISO8601" ]
    }

    # Add service name if not present
    if ![service] {
      mutate {
        add_field => { "service" => "unknown" }
      }
    }

    # Parse error logs
    if [level] == "error" or [status] >= 400 {
      mutate {
        add_tag => [ "error" ]
      }
    }

    # Parse warnings
    if [level] == "warn" {
      mutate {
        add_tag => [ "warning" ]
      }
    }

    # Parse security events
    if [message] =~ /Security Event/ {
      mutate {
        add_tag => [ "security" ]
      }
    }

    # Parse business events
    if [message] =~ /Business Event/ {
      mutate {
        add_tag => [ "business" ]
      }
    }

    # Parse performance logs
    if [message] =~ /Performance Metric/ {
      mutate {
        add_tag => [ "performance" ]
      }
    }
  }

  # Parse HTTP request logs
  if [type] == "http" or [fields][log_type] == "http" {
    grok {
      match => {
        "message" => "%{COMBINEDAPACHELOG}"
      }
    }

    date {
      match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
    }
  }

  # Add geoip for IP addresses
  if [ip] {
    geoip {
      source => "ip"
    }
  }

  # Remove sensitive data
  if [password] {
    mutate {
      replace => { "password" => "***" }
    }
  }
  if [token] {
    mutate {
      replace => { "token" => "***" }
    }
  }
  if [secret] {
    mutate {
      replace => { "secret" => "***" }
    }
  }

  # Add compute field for log severity
  if [level] {
    mutate {
      add_field => { "severity_num" => "0" }
    }
  }
  if [level] == "debug" {
    mutate { replace => { "severity_num" => "1" } }
  }
  if [level] == "info" {
    mutate { replace => { "severity_num" => "2" } }
  }
  if [level] == "warn" {
    mutate { replace => { "severity_num" => "3" } }
  }
  if [level] == "error" {
    mutate { replace => { "severity_num" => "4" } }
  }

  # Add environment tag
  if [service] {
    mutate {
      add_field => { "environment" => "${NODE_ENV:production}" }
    }
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "aio-logs-%{+YYYY.MM.dd}"
    template_name => "aio-logs"
    template_pattern => "aio-logs-*"

    # Template settings for index lifecycle management
    template => "/usr/share/logstash/templates/aiotemplate.json"
    template_overwrite => true
  }

  # Separate error logs
  if "error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "aio-errors-%{+YYYY.MM.dd}"
    }
  }

  # Separate security logs
  if "security" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "aio-security-%{+YYYY.MM.dd}"
    }
  }

  # Debug output to console in development
  if [environment] == "development" {
    stdout {
      codec => rubydebug
    }
  }
}

